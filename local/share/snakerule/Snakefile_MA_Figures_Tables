include: 'conf.sk'

rule ggplot_themes:
	output: Rimage='theme_{size}.Rdata'
	script: SRC_DIR+'/ggthemes.R'

### Supporting rules
SORTED_MR='sorted_MR_avg.tsv'
# rule whose end job is done by hand because 1599PR and LM needs manual positioning
rule avg:
    input: REF_DATASET+"/MR_edu_SNV_averaged.tsv"
    output: "sorted_MR_avg.tmp.tsv"
    shell: 
        """
            head -n1 {input} > {output}
            sed 1d {input} | grep -w CRC0282 {input} >> {output}
            sed 1d {input} | grep -v -w CRC0282 | sort -gk3,3 >> {output}
        """

### Figure 1
rule figure_1b_mr:
    input: MR=REF_DATASET+"/MR_edu_SNV", theme=GGTHEME, palette=MANY_COLORS_PALETTE, order=SORTED_MR
    output: plot='fig_1b_MR.svg', avgdata="fig_1b_avg.tsv"
    log: log="fig_1b_MR.log"
    script: SRC_DIR+'/fig1b_MR.R'

rule figure_1c_dnds:
    input: dnds=REF_DATASET+"/dnds1vitro_overall.tsv", theme=GGTHEME, palette=MODELS_COLORS_PALETTE, order=SORTED_MR
    output: plot='fig_1c_dnds.svg'
    script: SRC_DIR+'/fig1c_dnds.R'

### Figure 3
rule figure_3a_mr:
    input: MR=REF_DATASET+"/MR_edu_SNV", theme=GGTHEME, palette=MANY_COLORS_PALETTE, order=SORTED_MR
    output: plot='fig_3a_MR.svg', avgdata="fig_3a_avg.tsv"
    log: log="fig_3a_MR.log"
    script: SRC_DIR+'/fig3a_MR.R'

rule fig_3b_wilcox_mb:
    #input: #TCGA=SROOT+"/pdxopedia/dataset/mut_burdens/all_genes_mb_wilcox_TCGA.rds", WES=SROOT+"/pdxopedia/dataset/mut_burdens/all_genes_mb_wilcox_wes.rds", # alt for our servers
    input: TCGA=SOURCE_DATA+'/all_genes_mb_wilcox_TCGA.rds', WES=SOURCE_DATA+'/all_genes_mb_wilcox_wes.rds',
           theme=GGTHEME
    output: plot='fig_3b_wilcox_mb.svg'
    script: SRC_DIR+'/fig3b_wilcox.R'

### Figure 2
# bulk + vitro 1st
rule fig2_a:
    input: sign=REF_DATASET+"/vitrovivobulk_heatmap_merged_cosmic.tsv", 
           palette=MODELS_COLORS_PALETTE, order=SORTED_MR
    output: plot="fig_2a_cosmic.pdf"
    params: wanted="bulk", legend="yes", addlm="yes"
    script: SRC_DIR+'/fig2_cosmic.R'

rule fig_2a_bis:
    input: sign=REF_DATASET+"/vitrovivobulk_heatmap_merged_cosmic.tsv", 
           palette=MODELS_COLORS_PALETTE, order=SORTED_MR
    output: plot="fig_2abis_cosmic.pdf"
    params: wanted="vitroMA", legend="no", addlm="yes"
    script: SRC_DIR+'/fig2_cosmic.R'

# vivo 1st
rule fig_2b_bis:
    input: sign=REF_DATASET+"/vitrovivobulk_heatmap_merged_cosmic.tsv", 
           palette=MODELS_COLORS_PALETTE, order=SORTED_MR
    output: plot="fig_2b_cosmic.pdf"
    params: wanted="vivoMA", legend="no", addlm="yes"
    script: SRC_DIR+'/fig2_cosmic.R'

# cleverers
rule fig_2c:
    input: sign=REF_DATASET+"/cleverers_exposures.tsv", 
           palette=MODELS_COLORS_PALETTE_CLEV, order=SORTED_CLEV
    output: plot="fig_2c_cosmic.pdf"
    params: wanted="shared", legend="yes", addlm="no"
    script: SRC_DIR+'/fig2_cosmic.R'

rule fig_2c_bis:
    input: sign=REF_DATASET+"/cleverers_exposures.tsv", 
           palette=MODELS_COLORS_PALETTE_CLEV, order=SORTED_CLEV
    output: plot="fig_2cbis_cosmic.pdf"
    params: wanted="private", legend="yes", addlm="no"
    script: SRC_DIR+'/fig2_cosmic.R'

# clevers suppl
rule edfig_8:
    input: sign=REF_DATASET+"/clevers/heatmap_cosmic.tsv", 
           palette=MODELS_COLORS_PALETTE_CLE, order=SORTED_CLE
    output: plot="edfig_8_cosmic.pdf"
    params: wanted="trunk", legend="yes", addlm="no"
    script: SRC_DIR+'/fig2_cosmic.R'

rule edfig_8_bis:
    input: sign=REF_DATASET+"/clevers/heatmap_cosmic.tsv", 
           palette=MODELS_COLORS_PALETTE_CLE, order=SORTED_CLE
    output: plot="edfig_8bis_cosmic.pdf"
    params: wanted="leaves", legend="no", addlm="no"
    script: SRC_DIR+'/fig2_cosmic.R'

### Figure 4
rule vitro_heatmap:
    input: cn=REF_DATASET+'/cn_heatmap/vitro_merged.tsv.gz', order=SORTED_MR
    output: plot="fig_4a_cn_heatmap.pdf"
    log: log="fig_4a_cn_heatmap.log"
    script: SRC_DIR+'/heatmap_cn.py'

rule figure_4b_mr:
    input: MR=REF_DATASET+"/fixedcn_tree", theme=GGTHEME, palette=MANY_COLORS_PALETTE, order=SORTED_MR
    output: plot='fig_4b_CN.svg', avgdata="fig_4b_avg.tsv"
    log: log="fig_4b_CN.log"
    script: SRC_DIR+'/fig4b_CN.R'


rule figure_4_support_MR_also2nd:
    input: MR=REF_DATASET+"/MR_edu_SNV", theme=GGTHEME, palette=MANY_COLORS_PALETTE, order=SORTED_MR
    output: plot='support_4.svg', avgdata="support_4_avgMR.tsv"
    log: log="fig_4_support.log"
    script: SRC_DIR+'/fig4b_CN.R'

rule figure_4c_cor:
    input: mr="support_4_avgMR.tsv", cn="fig_4b_avg.tsv",  theme=GGTHEME, palette=MODELS_COLORS_PALETTE
    output: plot='fig_4c_cor.svg'
    log: log="fig_4c_cor.log"
    script: SRC_DIR+'/fig4c_cor.R'
    

### Figure 5
rule figure_5a_subclonal:
    input: subclonal=REF_DATASET+'/fixedthr_subclonal', MR=REF_DATASET+'/MR_edu_SNV',
           theme=GGTHEME, colors=MANY_COLORS_PALETTE
    output: plot='fig_5a_subclonal.svg', tsv="fig_5a_subclonal.tsv"
    log: log='fig_5a_subclonal.log'
    script: SRC_DIR+'/fig5a_subclonal.R'

rule figure_5b_vaf_histo:
    input: LM=SOURCE_DATA+'/CRC1599LMX0A02001TUMD03000V2.pass.table.snv.gz', PR=SOURCE_DATA+'/CRC1599PRX0A02002TUMD03000V2.pass.table.snv.gz',
           theme=GGTHEME
    output: plot='fig_5b_VAFhistogram.svg'
    script: SRC_DIR+'/fig5b_VAFhisto.R'

rule figure_5c_slopes:
    input: data=SOURCE_DATA+'/bestbet_0.12_0.24.tsv',
           theme=GGTHEME
    output: plot='fig_5c_slopes_pairedscatter.svg'
    log: log='fig_5c_slopes_pairedscatter.log'
    script: SRC_DIR+'/fig5c_slopes_pairedscatter.R'

# Supplementaty tables
rule supplementary_wilcox_mut_burden:
    input: genes=REF_DATASET+"/CRC1502-09C_CRC1502-09C_CRC1502-09-1-C.00.private.tsv", wilcox=SROOT+"/pdxopedia/dataset/mut_burdens/all_genes_mb_wilcox_{ref}"
    output: tsv="supplementary_wilcox_mut_burden_{ref}.tsv"
    script: SRC_DIR+'/filter_correct.R'

# Note: LM/PR were added by hand on drive for the first run of this. Automatize if need to re-run.
rule supplementary_edt_4_xlsx:
    input: exposures=REF_DATASET+"/vitrovivobulk_heatmap_merged_cosmic.tsv", cosine=REF_DATASET+"/vitrovivobulk_cosine_merged_cosmic.tsv"
    output: xls="Extended_Data_Table_4_signatures_vitrovivobulk.xlsx"
    shell:
        """
            bawk 'NR==1{{print "model","class",$0}}' {input.exposures} | perl -pne 's/(\d+)/SBS$1/g'> {output}.tmp
            tr "_" "\\t" < {input.exposures} | grep -v 2nd | sed 's/bulk/parental/' | sed 1d >> {output}.tmp
            echo -e "model\\tclass\\tcosine_similarity\\n" > {output}.tmp2
            sed 1d {input.cosine} | grep -v 2nd  | sed 's/bulk/parental/' | tr "_" "\\t" | cut -f 1,2,3 >> {output}.tmp2
            tsv_to_xls -i {output}.tmp,{output}.tmp2 -s exposures,cosine -o {output}
            rm {output}.tmp*
        """

rule supplementary_edt7_xlsx:
    input: exposures=REF_DATASET+"/cleverers_exposures.tsv", cosine=REF_DATASET+"/cleverers_cosine.tsv", 
           cleversexp=REF_DATASET+"/clevers/heatmap_cosmic.tsv", cleverscosine=REF_DATASET+"/clevers/cosine_cosmic.tsv"
    output: xls="Extended_Data_Table_7_signatures_cleverers.xlsx"
    shell:
        """
            bawk 'NR==1{{print "model","class",$0}}' {input.exposures} | cut -f 3 --complement | perl -pne 's/(\d+)/SBS$1/g'> {output}.tmp
            tr "_" "\\t" < {input.exposures} | sed 1d >> {output}.tmp
            tr "_" "\\t" < {input.cleversexp} | sed 1d >> {output}.tmp
            echo -en "model\\tclass\\tcosine_similarity\\n" > {output}.tmp2
            sed 1d {input.cosine} | tr "_" "\\t" | cut -f 1,2,3 >> {output}.tmp2
            sed 1d {input.cleverscosine} | tr "_" "\\t" | cut -f 1,2,3 >> {output}.tmp2
            tsv_to_xls -i {output}.tmp,{output}.tmp2 -s exposures,cosine -o {output}
            #rm {output}.tmp*
        """

# Note: LM/PR were added by hand on drive for the first run of this. Automatize if need to re-run.
rule supplementary_edt8_sign_xlsx:
    input: exposures=REF_DATASET+"/vitrovivobulk_heatmap_merged_cosmic.tsv", cosine=REF_DATASET+"/vitrovivobulk_cosine_merged_cosmic.tsv"
    output: xls="Extended_Data_Table_8_signaturesT2.xlsx"
    shell:
        """
            bawk 'NR==1{{print "model","class",$0}}' {input.exposures} | perl -pne 's/(\d+)/SBS$1/g'> {output}.tmp
            tr "_" "\\t" < {input.exposures} | grep 2nd | grep -v vivoMA >> {output}.tmp
            echo -e "model\\tclass\\tcosine_similarity\\n" > {output}.tmp2
            sed 1d {input.cosine} | grep 2nd | grep -v vivoMA | tr "_" "\\t" | cut -f 1,2,3 >> {output}.tmp2
            tsv_to_xls -i {output}.tmp,{output}.tmp2 -s exposures,cosine -o {output}
            rm {output}.tmp*
        """


# List of muts and details added by hand on drive (?)
rule supplementary_edt9_xlsx:
    input: TCGA="supplementary_wilcox_mut_burden_TCGA.tsv", WES="supplementary_wilcox_mut_burden_wes.tsv"
    output: "Extended_Data_Table_9_wilcox_mutburden.xlsx"
    shell: "tsv_to_xls -i {input.TCGA},{input.WES} -s TCGA,WES -o {output}"

rule supplementary_edt10_xlsx:
    input: tsv="fig_5a_subclonal.tsv"
    output: "Extended_Data_Table_10_nsubclonal.xlsx"
    shell: "tsv_to_xls -i {input.tsv} -s n_subclonal -o {output}"

# Supplementary Figures
rule supplementary_edf1b_edu:
    input: edu=PRJ_ROOT+'/local/share/data/edf1b_EDU.txt', theme=GGTHEME, palette=MANY_COLORS_PALETTE, order=SORTED_MR
    output: plot='edf1b_EDU.svg'
    script: SRC_DIR+'/edfig1b_EDU.R'
#controllare si /0.0000001 e unità di misura asse y MR
rule supplementary_edf2_indel:
    input: MR=REF_DATASET+"/MR_edu_indel", theme=GGTHEME, palette=MANY_COLORS_PALETTE, order=SORTED_MR
    output: plot='edf2_indel.svg', avgdata="edf2_indel_avg.tsv"
    log: log="edf2_indel.log"
    script: SRC_DIR+'/edf2_indel.R'

# XXX these two have total N and N normalized by len only, so the
# transformation of y axis should be removed/changed
# y axis here is absolute n of SNVs ( SNVs )

#controllare no /0.00000001, e unità di misura asse y deve essere SNVs
rule supplementary_edf3a_N:
    input: MR=REF_DATASET+"/vitro_gained_SNV", theme=GGTHEME, palette=MANY_COLORS_PALETTE, order=SORTED_MR
    output: plot='edf3a_N.svg', avgdata="edf3a_N_avg.tsv"
    log: log="edf3a_N.log"
    script: SRC_DIR+'/edfig3a_N.R'

# y axis here is MR [SNVs/(Gbp*effective_division)] (do / 0.000000001)
# per avere idea del range plot basico brutto: datasetV2/MR_conte_SNV.png
rule supplementary_edf3b_nN:
    input: MR=REF_DATASET+"/MR_conte_SNV", theme=GGTHEME, palette=MANY_COLORS_PALETTE, order=SORTED_MR
    output: plot='edf3b_nN.svg', avgdata="edf3b_nN_avg.tsv"
    log: log="edf3b_nN.log"
    script: SRC_DIR+'/edf3b_nN.R'

rule supplementary_edf4a_localiz:
    input: data=REF_DATASET+'/annotatr_locations.tsv', theme=GGTHEME
    output: plot='edf4a_localiz.svg'
    log: log='edf4a_localiz.log'
    script: SRC_DIR+'/edfig4a_localiz.R'

rule supplementary_edf4b_essential:
    input: bulk=REF_DATASET+'/bulk_essential_n.tsv', gained=REF_DATASET+"/SNV_essential_n.tsv", theme=GGTHEME
    output: plot='edf4b_essential.svg'
    log: log='edf4b_essential.log'
    script: SRC_DIR+'/edfig4b_essential.R'


rule figure_edf6_mr:
    input: MR=REF_DATASET+"/fixedsnvindel_tree", theme=GGTHEME, palette=MANY_COLORS_PALETTE, order=SORTED_MR
    output: plot='edf6_support.svg', avgdata="edf6_avg.tsv"
    log: log="edf6_snvindel.log"
    script: SRC_DIR+'/fig4b_CN.R'

rule supplementary_edf6_tree_MR:
    input: mr="support_4_avgMR.tsv", tree="edf6_avg.tsv",  theme=GGTHEME, palette=MODELS_COLORS_PALETTE
    output: plot='edf6_cor.svg'
    log: log="edf6_cor.log"
    script: SRC_DIR+'/edfig6_cor.R'

SORTED_MR_T2=PRJ_ROOT+'/local/share/data/sorted_MR_avg_T2.tsv'
rule supplementary_edf9a:
    input: dnds=REF_DATASET+"/dnds_t2_vitro_overall.tsv", theme=GGTHEME, palette=MODELS_COLORS_PALETTE, order=SORTED_MR_T2
    output: plot='edf9a_dnds.svg'
    script: SRC_DIR+'/fig1c_dnds.R'

rule supplementary_edf9b:
    input: sign=REF_DATASET+"/vitrovivobulk_heatmap_merged_cosmic.tsv", 
           palette=MODELS_COLORS_PALETTE, order=SORTED_MR
    output: plot="edf9b_cosmic.pdf"
    params: wanted="2nd_vitroMA", legend="no", addlm="yes"
    script: SRC_DIR+'/fig2_cosmic.R'


rule supplementary_edf10:
    input: N=REF_DATASET+"/vitro_gained_SNV", theme=GGTHEME, palette=MANY_COLORS_PALETTE, order=SORTED_MR
    output: plot='edf10_hyp.svg'
    script: SRC_DIR+'/edfig10_hyp.R'

rule edf_12a_R2:
    input: data=SOURCE_DATA+'/all_bets.tsv',
           theme=GGTHEME
    output: plot='edfig_12a_R2.svg'
    script: SRC_DIR+'/edfig_12a_R2_.R'

rule figure_12b_slopes_noout:
    input: data=SOURCE_DATA+'/bestbet_0.12_0.24.tsv',
           theme=GGTHEME
    params: what="slopes"
    output: plot='edfig_12b_slopes.svg'
    log: log='fig_12b_slopes.log'
    script: SRC_DIR+'/fig12bc_slopes.R'

rule figure_12c_subcl:
    input: data=SOURCE_DATA+'/bestbet_0.12_0.24.tsv',
           theme=GGTHEME
    params: what="subcl"
    output: plot='edfig_12c_subcl.svg'
    log: log='fig_12c_subcl.log'
    script: SRC_DIR+'/fig12bc_slopes.R'

######################## miscellanea
# diary 25/05/23 for code run on newer R (4.3.0) on cog + add LM to 1599BULK manually
# edf7
rule signal_fig2_a:
    input: sign=SOURCE_DATA+'/exposures2.tsv', 
           palette=MODELS_COLORS_PALETTE, order=SORTED_MR
    output: plot="fig_2a_signal.pdf"
    params: wanted="bulk", legend="yes", addlm="yes", norm="yes"
    script: SRC_DIR+'/fig2_signal.R'

rule signal_fig_2a_bis:
    input: sign=SOURCE_DATA+'/exposures2.tsv', 
           palette=MODELS_COLORS_PALETTE, order=SORTED_MR
    output: plot="fig_2abis_signal.pdf"
    params: wanted="vitroMA", legend="no", addlm="yes", norm="yes"
    script: SRC_DIR+'/fig2_signal.R'

# vivo 1st
rule signal_fig_2b_bis:
    input: sign=SOURCE_DATA+'/exposures2.tsv', 
           palette=MODELS_COLORS_PALETTE, order=SORTED_MR
    output: plot="fig_2b_signal.pdf"
    params: wanted="vivoMA", legend="no", addlm="yes", norm="yes"
    script: SRC_DIR+'/fig2_sigfit.R'

rule sigfit_fig2_a:
    input: sign=SOURCE_DATA+'/sigfit.tsv', 
           palette=MODELS_COLORS_PALETTE, order=SORTED_MR
    output: plot="fig_2a_sigfit.pdf"
    params: wanted="bulk", legend="yes", addlm="yes", norm="no"
    script: SRC_DIR+'/fig2_sigfit.R'

rule sigfit_fig_2a_bis:
    input: sign=SOURCE_DATA+'/sigfit.tsv', 
           palette=MODELS_COLORS_PALETTE, order=SORTED_MR
    output: plot="fig_2abis_sigfit.pdf"
    params: wanted="vitroMA", legend="no", addlm="yes", norm="no"
    script: SRC_DIR+'/fig2_sigfit.R'

# vivo 1st
rule sigfit_fig_2b_bis:
    input: sign=SOURCE_DATA+'/sigfit.tsv', 
           palette=MODELS_COLORS_PALETTE, order=SORTED_MR
    output: plot="fig_2b_sigfit.pdf"
    params: wanted="vivoMA", legend="no", addlm="yes", norm="no"
    script: SRC_DIR+'/fig2_sigfit.R'


# check edf6 version gained muts
rule figure_edf6bis_mr:
    input: MR=REF_DATASET+"/vitro_T1gained_firstSNV", theme=GGTHEME, palette=MANY_COLORS_PALETTE, order=SORTED_MR
    output: plot='edf6bis_support.svg', avgdata="edf6bis_avg.tsv"
    log: log="edf6bis_snvindel.log"
    script: SRC_DIR+'/fig4b_CN.R'

rule supplementary_edf6bis_tree_MR:
    input: mr="support_4_avgMR.tsv", tree="edf6bis_avg.tsv",  theme=GGTHEME, palette=MODELS_COLORS_PALETTE
    output: plot='edf6bis_cor.svg'
    log: log="edf6bis_cor.log"
    script: SRC_DIR+'/edfig6_cor.R'


rule perle:
    input: '{qualunque}.svg'
    output: 'perlati/{qualunque}.svg'
    shell:
        """
            mkdir -p perlati
            perl -pne "s/textLength='.+px'//; " < {input} > {output}
        """


# msigact
# input generated on rotpunkt via msigact.R and manual removal of LMO/O for bulk
rule msigact_fig2_a:
    input: sign=SOURCE_DATA+'/lmsigact.tsv', 
           palette=MODELS_COLORS_PALETTE, order=SORTED_MR
    output: plot="fig_2a_msigact.pdf"
    params: wanted="bulk", legend="yes", addlm="yes", norm="no"
    script: SRC_DIR+'/fig2_msigact.R'

rule msigact_fig_2a_bis:
    input: sign=SOURCE_DATA+'/lmsigact.tsv', 
           palette=MODELS_COLORS_PALETTE, order=SORTED_MR
    output: plot="fig_2abis_msigact.pdf"
    params: wanted="vitroMA", legend="no", addlm="yes", norm="no"
    script: SRC_DIR+'/fig2_msigact.R'

# vivo 1st
rule msigact_fig_2b_bis:
    input: sign=SOURCE_DATA+'/lmsigact.tsv', 
           palette=MODELS_COLORS_PALETTE, order=SORTED_MR
    output: plot="fig_2b_msigact.pdf"
    params: wanted="vivoMA", legend="no", addlm="yes", norm="no"
    script: SRC_DIR+'/fig2_msigact.R'