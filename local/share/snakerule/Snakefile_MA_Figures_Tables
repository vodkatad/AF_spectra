include: 'conf.sk'

rule ggplot_themes:
	output: Rimage='theme_{size}.Rdata'
	script: SRC_DIR+'/ggthemes.R'

### Supporting rules
SORTED_MR='sorted_MR_avg.tsv'
# rule whose end job is done by hand because 1599PR and LM needs manual positioning
rule avg:
    input: REF_DATASET+"/MR_edu_SNV_averaged.tsv"
    output: "sorted_MR_avg.tmp.tsv"
    shell: 
        """
            head -n1 {input} > {output}
            sed 1d {input} | grep -w CRC0282 {input} >> {output}
            sed 1d {input} | grep -v -w CRC0282 | sort -gk3,3 >> {output}
        """

### Figure 1
rule figure_1b_mr:
    input: MR=REF_DATASET+"/MR_edu_SNV", theme=GGTHEME, palette=MANY_COLORS_PALETTE, order=SORTED_MR
    output: plot='fig_1b_MR.svg', avgdata="fig_1b_avg.tsv"
    log: log="fig_1b_MR.log"
    script: SRC_DIR+'/fig1b_MR.R'

rule figure_1c_dnds:
    input: dnds=REF_DATASET+"/dnds1vitro_overall.tsv", theme=GGTHEME, palette=MODELS_COLORS_PALETTE, order=SORTED_MR
    output: plot='fig_1c_dnds.svg'
    script: SRC_DIR+'/fig1c_dnds.R'

### Figure 3
rule figure_3a_mr:
    input: MR=REF_DATASET+"/MR_edu_SNV", theme=GGTHEME, palette=MANY_COLORS_PALETTE, order=SORTED_MR
    output: plot='fig_3a_MR.svg', avgdata="fig_3a_avg.tsv"
    log: log="fig_3a_MR.log"
    script: SRC_DIR+'/fig3a_MR.R'

rule fig_3b_wilcox_mb:
    #input: #TCGA=SROOT+"/pdxopedia/dataset/mut_burdens/all_genes_mb_wilcox_TCGA.rds", WES=SROOT+"/pdxopedia/dataset/mut_burdens/all_genes_mb_wilcox_wes.rds", # alt for our servers
    input: TCGA=SOURCE_DATA+'/all_genes_mb_wilcox_TCGA.rds', WES=SOURCE_DATA+'/all_genes_mb_wilcox_wes.rds',
           theme=GGTHEME
    output: plot='fig_3b_wilcox_mb.svg'
    script: SRC_DIR+'/fig3b_wilcox.R'

### Figure 2
# bulk + vitro 1st
rule fig2_a:
    input: sign=REF_DATASET+"/vitrovivobulk_heatmap_merged_cosmic.tsv", 
           palette=MODELS_COLORS_PALETTE, order=SORTED_MR
    output: plot="fig_2a_cosmic.pdf"
    params: wanted="bulk", legend="yes", addlm="yes"
    script: SRC_DIR+'/fig2_cosmic.R'

rule fig_2a_bis:
    input: sign=REF_DATASET+"/vitrovivobulk_heatmap_merged_cosmic.tsv", 
           palette=MODELS_COLORS_PALETTE, order=SORTED_MR
    output: plot="fig_2abis_cosmic.pdf"
    params: wanted="vitroMA", legend="no", addlm="yes"
    script: SRC_DIR+'/fig2_cosmic.R'

# vivo 1st
rule fig_2b_bis:
    input: sign=REF_DATASET+"/vitrovivobulk_heatmap_merged_cosmic.tsv", 
           palette=MODELS_COLORS_PALETTE, order=SORTED_MR
    output: plot="fig_2b_cosmic.pdf"
    params: wanted="vivoMA", legend="no", addlm="yes"
    script: SRC_DIR+'/fig2_cosmic.R'

# cleverers
rule fig_2c:
    input: sign=REF_DATASET+"/cleverers_exposures.tsv", 
           palette=MODELS_COLORS_PALETTE_CLEV, order=SORTED_CLEV
    output: plot="fig_2c_cosmic.pdf"
    params: wanted="shared", legend="yes", addlm="no"
    script: SRC_DIR+'/fig2_cosmic.R'

rule fig_2c_bis:
    input: sign=REF_DATASET+"/cleverers_exposures.tsv", 
           palette=MODELS_COLORS_PALETTE_CLEV, order=SORTED_CLEV
    output: plot="fig_2cbis_cosmic.pdf"
    params: wanted="private", legend="no", addlm="no"
    script: SRC_DIR+'/fig2_cosmic.R'

# clevers suppl
rule edfig_8:
    input: sign=REF_DATASET+"/clevers/heatmap_cosmic.tsv", 
           palette=MODELS_COLORS_PALETTE_CLE, order=SORTED_CLE
    output: plot="edfig_8_cosmic.pdf"
    params: wanted="trunk", legend="yes", addlm="no"
    script: SRC_DIR+'/fig2_cosmic.R'

rule edfig_8_bis:
    input: sign=REF_DATASET+"/clevers/heatmap_cosmic.tsv", 
           palette=MODELS_COLORS_PALETTE_CLE, order=SORTED_CLE
    output: plot="edfig_8bis_cosmic.pdf"
    params: wanted="leaves", legend="no", addlm="no"
    script: SRC_DIR+'/fig2_cosmic.R'

### Figure 4
rule vitro_heatmap:
    input: cn=REF_DATASET+'/cn_heatmap/vitro_merged.tsv.gz', order=SORTED_MR
    output: plot="fig_4a_cn_heatmap.pdf"
    log: log="fig_4a_cn_heatmap.log"
    script: SRC_DIR+'/heatmap_cn.py'

rule figure_4b_mr:
    input: MR=REF_DATASET+"/fixedcn_tree", theme=GGTHEME, palette=MANY_COLORS_PALETTE, order=SORTED_MR
    output: plot='fig_4b_CN.svg', avgdata="fig_4b_avg.tsv"
    log: log="fig_4b_CN.log"
    script: SRC_DIR+'/fig4b_CN.R'


rule figure_4_support_MR_also2nd:
    input: MR=REF_DATASET+"/MR_edu_SNV", theme=GGTHEME, palette=MANY_COLORS_PALETTE, order=SORTED_MR
    output: plot='support_4.svg', avgdata="support_4_avgMR.tsv"
    log: log="fig_4_support.log"
    script: SRC_DIR+'/fig4b_CN.R'

rule figure_4c_cor:
    input: mr="support_4_avgMR.tsv", cn="fig_4b_avg.tsv",  theme=GGTHEME, palette=MODELS_COLORS_PALETTE
    output: plot='fig_4c_cor.svg'
    log: log="fig_4c_cor.log"
    script: SRC_DIR+'/fig4c_cor.R'
    

### Figure 5
rule figure_5a_subclonal:
    input: subclonal=REF_DATASET+'/fixedthr_subclonal', MR=REF_DATASET+'/MR_edu_SNV',
           theme=GGTHEME, colors=MANY_COLORS_PALETTE
    output: plot='fig_5a_subclonal.svg'
    log: log='fig_5a_subclonal.log'
    script: SRC_DIR+'/fig5a_subclonal.R'

rule figure_5b_vaf_histo:
    input: LM=SOURCE_DATA+'/CRC1599LMX0A02001TUMD03000V2.pass.table.snv.gz', PR=SOURCE_DATA+'/CRC1599PRX0A02002TUMD03000V2.pass.table.snv.gz',
           theme=GGTHEME
    output: plot='fig_5b_VAFhistogram.svg'
    script: SRC_DIR+'/fig5b_VAFhisto.R'

rule figure_5c_vaf_histo:
    input: data=SOURCE_DATA+'/bestbet_0.12_0.24.tsv',
           theme=GGTHEME
    output: plot='fig_5c_slopes_pairedscatter.svg'
    log: log='fig_5c_slopes_pairedscatter.log'
    script: SRC_DIR+'/fig5c_slopes_pairedscatter.R'

# Supplementaty tables
rule supplementary_wilcox_mut_burden:
    input: genes=REF_DATASET+"/CRC1502-09C_CRC1502-09C_CRC1502-09-1-C.00.private.tsv", wilcox=SROOT+"/pdxopedia/dataset/mut_burdens/all_genes_mb_wilcox_{ref}"
    output: tsv="supplementary_wilcox_mut_burden_{ref}.tsv"
    script: SRC_DIR+'/filter_correct.R'

# TODO add LMX/PRX
rule supplementary_edt_4_xlsx:
    input: exposures=REF_DATASET+"/vitrovivobulk_heatmap_merged_cosmic.tsv", cosine=REF_DATASET+"/vitrovivobulk_cosine_merged_cosmic.tsv"
    output: xls="Extended_Data_Table_4_signatures_vitrovivobulk.xlsx"
    shell:
        """
            bawk 'NR==1{{print "model","class",$0}}' {input.exposures} | perl -pne 's/(\d+)/SBS$1/g'> {output}.tmp
            tr "_" "\\t" < {input.exposures} | grep -v 2nd | sed 's/bulk/parental/' | sed 1d >> {output}.tmp
            echo -e "model\\tclass\\tcosine_similarity\\n" > {output}.tmp2
            sed 1d {input.cosine} | grep -v 2nd  | sed 's/bulk/parental/' | tr "_" "\\t" | cut -f 1,2,3 >> {output}.tmp2
            tsv_to_xls -i {output}.tmp,{output}.tmp2 -s exposures,cosine -o {output}
            rm {output}.tmp*
        """

# TODO add clevers
rule supplementary_edt7_xlsx:
    input: exposures=REF_DATASET+"/cleverers_exposures.tsv", cosine=REF_DATASET+"/cleverers_cosine.tsv", 
           cleversexp=REF_DATASET+"/clevers/heatmap_cosmic.tsv", cleverscosine=REF_DATASET+"/clevers/cosine_cosmic.tsv"
    output: xls="Extended_Data_Table_7_signatures_cleverers.xlsx"
    shell:
        """
            bawk 'NR==1{{print "model","class",$0}}' {input.exposures} | cut -f 3 --complement | perl -pne 's/(\d+)/SBS$1/g'> {output}.tmp
            tr "_" "\\t" < {input.exposures} | sed 1d >> {output}.tmp
            tr "_" "\\t" < {input.cleversexp} | sed 1d >> {output}.tmp
            echo -en "model\\tclass\\tcosine_similarity\\n" > {output}.tmp2
            sed 1d {input.cosine} | tr "_" "\\t" | cut -f 1,2,3 >> {output}.tmp2
            sed 1d {input.cleverscosine} | tr "_" "\\t" | cut -f 1,2,3 >> {output}.tmp2
            tsv_to_xls -i {output}.tmp,{output}.tmp2 -s exposures,cosine -o {output}
            #rm {output}.tmp*
        """

rule supplementary_edt9_xlsx:
    input: TCGA="supplementary_wilcox_mut_burden_TCGA.tsv", WES="supplementary_wilcox_mut_burden_wes.tsv"
    output: "Extended_Data_Table_9_wilcox_mutburden.xlsx"
    shell: "tsv_to_xls -i {input.TCGA},{input.WES} -s TCGA,WES -o {output}"
