include: "./conf.sk"

rule all_tsv:
    input: expand("{sample}.tsv.gz", sample=SAMPLES)

# why decoy are in callable interval list?? let's start with chr1-22 only, sequenza is on 1-22-X-Y only right now
rule process_vcf:
    input: vcf=DATA+"/{sample}.pass.vcf.gz", chrs=DATA+"/chrs"
    output: "{sample}.tsv.gz"
    params: tool=BIN_DIR+"/vcf_to_bed", multi=MULTI, kind=KIND, sample=SAMPLE
    log: "{sample}.multiallelic"
    shell:
        """
            bcftools view -s {wildcards.sample} {input.vcf} | bcftools annotate -I +'%CHROM:%POS:%REF:%ALT' - \\
            | grep -v "^#" |  filter_1col 1 {input.chrs} | {params.tool} {params.kind} {params.multi} 2> {log} | gzip > {output}
        """

#rule plot_cnv:
#    input: sequenza=DATA+"/{sample}_segments.txt", callable=CALLABLE
#    output: "{sample}.coverage.cn.png"

rule intersect_cnv:
    input: var="{sample}.tsv.gz", sequenza=DATA+"/{sample}_segments.txt", callable=CALLABLE, chrs=DATA+"/chrs"
    output: var="{sample}.var_cnv.tsv.gz", callable="{sample}.callable.bed.gz"

rule AF_spectra_cn:
    input: "{sample}.var_cnv.tsv.gz"
    output: "{sample}.AF.png"

rule binomial:
    input: "{sample}.var_cnv.tsv.gz"
    output: "{sample}.calls.tsv.gz"
    params: WANTED_CN

rule pair:
    input: a="{asample}.calls.tsv.gz", b="{bsample}.calls.tsv.gz"

rule pair_length:
    input: a="{asample}.callable.bed.gz", b="{bsample}.callable.bed.gz"
    params: WANTED_CN